<html>

<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="jquery.fullPage.css" />

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
<script type="text/javascript" src="jquery.fullPage.min.js"></script>
<script type="text/javascript" src="jquery.svg.min.js"></script
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	
<style type="text/css">

body {
  background-image: url('bg.jpg');
  background-size: cover;
  margin: 0;
  padding: 0;
}

#gradient {
  background-image: linear-gradient(60deg, 
    rgba(255,255,255,1.0), 
    rgba(255,255,255,1.0), 
    rgba(255,255,255,0.5), 
    rgba(255,255,255,0.0));
  position: absolute;
  top: 0;
  bottom: 0;
  height: 100%;
  width: 100%;
  z-index: -2;
}

#regions {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
} 

#regions svg {
  height: 100%;
  width: 100%;
}

#marine {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 50%;
}
</style>
<script type="text/javascript">
var conditions = ["Very Good", "Good", "Moderate", "Poor", "Very Poor"];
var regions = [
  'gbr',
  'cape-york',
  'wet-tropics',
  'burdekin',
  'mackay-whitsunday',
  'fitzroy',
  'burnett-mary'
];
var indicators = [
  'overall',
  'water-chlorophyll',
  'coral-change',
  'coral-juvenile',
  'coral-macroalgae',
  'coral-cover',
  'seagrass-abundance',
  'seagrass-reproduction',
  'seagrass-nutrient',
  'water',
  'coral',
  'seagrass',
  'water-solids'
];

var marineData = regions.reduce(function(hr, vr) {
  hr[vr] = indicators.reduce(function(hi, vi) {
    var randomIndex = Math.floor(Math.random()*conditions.length);
    if (vi.indexOf('coral') == 0 && (vr == 'cape-york' || vr == 'burnett-mary')) {
      hi[vi] = 'NA';
    } else {
      hi[vi] = conditions[randomIndex];
    }
    return hi;
  }, {});
  return hr;
}, {})

function getFill(v) {
  var fills = {
    'Very Good': {
      'normal': '#7aff66',
      'active': '#22ff00'
    },
    'Good': {
      'normal': '#cfff66',
      'active': '#b0ff00'
    },
    'Moderate': {
      'normal': '#fff666',
      'active': '#fff000'
    },
    'Poor': {
      'normal': '#ffc766',
      'active': '#ffa200'
    },
    'Very Poor': {
      'normal': '#ff6966',
      'active': '#ff0400'
    }
  };
  if (fills[v]) {
    return fills[v];
  } else {
    return { normal: '#e5e5e5', active: '#e5e5e5' };
  }
}

function getRegionData(indicator) {
  return Object.keys(marineData).reduce(function(h, k) {
    console.log(k, indicator);
    h[k] = marineData[k][indicator];
    return h;
  }, {});
}

function getMarineStyle(values) {
  return Object.keys(values).map(function(key) {
    var value = values[key];
    return '#'+key+" { fill: "+getFill(value).normal+"; pointer-events: all; }\n" +
           '#'+key+":hover, #"+key+".active { fill: "+getFill(value).active+"; cursor: pointer; }";
  }).join("\n");
}

function getRegionStyle(values) {
  return Object.keys(values).map(function(key) {
    var value = values[key];
    if (value == 'NA') {
      return '#'+key+" { display: none; }";
    }
    return '#'+key+" { fill: "+getFill(value).normal+"; }";
  }).join("\n");
}

$(document).ready(function() {
  $.fn.fullpage({
    verticalCentered: false,
    css3: true,
    fixedElements: '#gradient, #regions'
  });
  function loadSvg(containerSelector, url) {
    $(containerSelector).svg();
    var svg = $(containerSelector).svg('get');
    var d = $.Deferred();
    svg.load(url, { 
      onLoad: function() {
        svg.configure({
          'height': '100%',
          'width': '100%',
          'preserveAspectRatio': 'xMinYMin meet'
        }, false);
        d.resolve(svg);
      }
    });
    return d.promise();
  }
  var setFocus = (function() { 
    var focused = null;
    return function (element) {
      if (focused) {
        $(focused).attr('class', '');
      }
      focused = element;
      $(focused).attr('class', 'active');
    };
  })();

  loadSvg('#regions', 'regions.svg').done(function(regions) {
    var setRegionStyle = (function() {
      var style = null;
      return function (styleContent) {
        if (style) {
          regions.remove(style);
        }
        style = regions.style(styleContent);
      };
    })();
    loadSvg('#marine', 'marine.svg').done(function(marine) {
      marine.style(getMarineStyle(marineData.gbr));
      Object.keys(marineData.gbr).forEach(function(id) {
        var e = marine.getElementById(id);
        if (e) {
          $(e).on('click', function(evt) {
            setFocus(evt.delegateTarget);
            setRegionStyle(getRegionStyle(getRegionData(id)));
          });
        }
      });
    });
  });
});
</script>

<body>

<div id="gradient"></div>
<div id="regions"></div>

<div>
  <div class="section" id="section0">
    <div class="row">
      <div class="col-xs-6 col-xs-offset-6">
        <h1>Map</h1>
        <p>Scroll Down</p>
      </div>
    </div>
  </div>
  <div class="section" id="section1">
    <div id="marine"></div>
  </div>
</div>

</body>
</html>
